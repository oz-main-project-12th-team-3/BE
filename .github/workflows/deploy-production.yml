name: â­ Deploy to Production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  quality-gate:
    uses: ./.github/workflows/code-quality.yml
    secrets: inherit

  build-and-deploy-prod:
    needs: quality-gate
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: â¬‡ï¸ Checkout code
      uses: actions/checkout@v4

    # --- ë°°í¬ ì „ëµ ë° í™˜ê²½ ì„¤ì • ê°€ì´ë“œ ---
    # ì´ ì›Œí¬í”Œë¡œìš°ëŠ” í”„ë¡œë•ì…˜ í™˜ê²½ìœ¼ë¡œì˜ ë°°í¬ë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤.
    #
    # 1. ë°°í¬ ì „ëµ:
    #    í˜„ì¬ëŠ” Elastic Beanstalkì„ í†µí•œ ì§ì ‘ ë°°í¬ ë°©ì‹ì…ë‹ˆë‹¤.
    #    í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ë” ì•ˆì •ì ì¸ ì „ëµ(ì˜ˆ: Blue/Green, Canary)ì„ ê°•ë ¥íˆ ê¶Œì¥í•©ë‹ˆë‹¤.
    #    í•´ë‹¹ ì „ëµì— ë§ëŠ” ì¶”ê°€ ë‹¨ê³„ë‚˜ ë„êµ¬(ì˜ˆ: AWS CodeDeploy, Spinnaker)ë¥¼ í†µí•©í•´ì•¼ í•©ë‹ˆë‹¤.
    #    ì˜ˆì‹œ: Blue/Green ë°°í¬ë¥¼ ìœ„í•´ ìƒˆ í™˜ê²½ì— ë°°í¬ í›„ íŠ¸ë˜í”½ ì „í™˜ ë¡œì§ ì¶”ê°€
    #
    # 2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •:
    #    í™˜ê²½ë³„ë¡œ ë‹¤ë¥¸ ì„¤ì •(ì˜ˆ: API ì—”ë“œí¬ì¸íŠ¸, ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë¬¸ìì—´)ì´ í•„ìš”í•œ ê²½ìš°,
    #    GitHub Environmentsì˜ Secrets ë˜ëŠ” Variables ê¸°ëŠ¥ì„ í™œìš©í•˜ê±°ë‚˜,
    #    ì• í”Œë¦¬ì¼€ì´ì…˜ ë‚´ì—ì„œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ë¡œë“œí•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
    #    ì˜ˆì‹œ: - name: Set Production Environment Variables
    #            run: |
    #              echo "API_URL=https://api.production.example.com" >> $GITHUB_ENV
    #              echo "DB_HOST=${{ vars.PRODUCTION_DB_HOST }}" >> $GITHUB_ENV
    #
    # -----------------------------------

    - name: ğŸ”‘ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-2 # ì˜ˆ: ap-northeast-2

    - name: ğŸ“¦ Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: ğŸ Build, tag, and push image to Amazon ECR
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: oz-be-main-project # ì˜ˆ: oz-be-repo
        IMAGE_TAG: ${{ github.ref_name }}
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

    - name: â­ Deploy to Elastic Beanstalk Production
      uses: einaregilsson/beanstalk-deploy@v21
      with:
        aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        application_name: oz-digital-human # EB ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„
        environment_name: oz-production # Production í™˜ê²½ ì´ë¦„
        version_label: ${{ github.ref_name }}
        region: ap-northeast-2 # ì˜ˆ: ap-northeast-2
        deployment_package: docker-compose.yml # Docker ë°°í¬ ëª…ì‹œ

    # --- ë¡¤ë°± ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ ---
    # ë°°í¬ ì‹¤íŒ¨ ë˜ëŠ” ë¬¸ì œ ë°œìƒ ì‹œ ë¡¤ë°±ì„ ìœ„í•œ ë‹¨ê³„ì…ë‹ˆë‹¤.
    # ì‹¤ì œ ë¡¤ë°± ëª…ë ¹ì–´ëŠ” ë°°í¬ ë°©ì‹(ì˜ˆ: Elastic Beanstalk, Kubernetes)ì— ë”°ë¼ ë‹¬ë¼ì§‘ë‹ˆë‹¤.
    # í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ìë™ ë¡¤ë°± ë˜ëŠ” ìˆ˜ë™ ë¡¤ë°± ì ˆì°¨ë¥¼ ëª…í™•íˆ ì •ì˜í•´ì•¼ í•©ë‹ˆë‹¤.
    #
    # ì˜ˆì‹œ: Elastic Beanstalkì˜ ê²½ìš°, ì´ì „ ë²„ì „ìœ¼ë¡œ í™˜ê²½ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” ëª…ë ¹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    # - name: â†©ï¸ Rollback on Failure (Placeholder)
    #   if: ${{ failure() }} # ì´ì „ ë‹¨ê³„ê°€ ì‹¤íŒ¨í–ˆì„ ë•Œë§Œ ì‹¤í–‰
    #   run: |
    #     echo "âš ï¸ Deployment failed. Initiating rollback to previous stable version..."
    #     # ì—¬ê¸°ì— ì‹¤ì œ ë¡¤ë°± ëª…ë ¹ì–´ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.
    #     # ì˜ˆ: aws elasticbeanstalk update-environment --environment-name your-env --version-label previous-version
    #     # ì˜ˆ: kubectl rollout undo deployment/your-app
    #     echo "âœ… Rollback initiated. Please verify manually."
    # -----------------------------------
